from unittest.mock import patch

from spotify_api.client import spotify_builder
from spotify_api.model import Track, Album, Artist, Image


from tests.mocks import MockResponse


@patch('spotify_api.repository.requests.post', autospec=True, spec_set=True, return_value=MockResponse(200, {'access_token': '', 'token_type': '', 'expires_in': 99, 'scope': ''}))
@patch('spotify_api.repository.requests.get', autospec=True, spec_set=True)
class TestSpotify:
    def test_get_access_token(self, mock_requests, mock_oauth, token: dict) -> None:
        mock_oauth.return_value = MockResponse(200, token)
        client = spotify_builder('id-lol', 'secret')
        client.get_token()
        client.get_token()
        mock_oauth.assert_called_once()

    def test_track(self, mock_requests, mock_oauth, track_fixture: dict) -> None:
        mock_requests.return_value = MockResponse(200, track_fixture)
        result = spotify_builder('id-lol', 'secret').get_track('5dPRMnwZ7CeQF4oolO8lYo')
        assert result == Track(id='5dPRMnwZ7CeQF4oolO8lYo', name='Sick Individual', external_urls={'spotify': 'https://open.spotify.com/track/5dPRMnwZ7CeQF4oolO8lYo'}, href='https://api.spotify.com/v1/tracks/5dPRMnwZ7CeQF4oolO8lYo', uri='spotify:track:5dPRMnwZ7CeQF4oolO8lYo', type='track', duration_ms=207666, preview_url='https://p.scdn.co/mp3-preview/bd4661b82bf4026f7b1a930d3efcf82824c94b08?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=True, track_number=3, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist')], is_local=False, album=Album(id='6jPjpEJBxT0HN71TAEohZ0', name='Into The Wild Life (Deluxe)', external_urls={'spotify': 'https://open.spotify.com/album/6jPjpEJBxT0HN71TAEohZ0'}, href='https://api.spotify.com/v1/albums/6jPjpEJBxT0HN71TAEohZ0', uri='spotify:album:6jPjpEJBxT0HN71TAEohZ0', type='album', available_markets=['ES','GB'], images=[Image(url='https://i.scdn.co/image/168d56d2615587c0f64a7357b94bd7e985fc52b4', height=640, width=640), Image(url='https://i.scdn.co/image/151e20dee06ace62b90bb970291cc59487552637', height=64, width=64)], total_tracks=15, release_date='2015-04-10', release_date_precision='day', artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist')], album_type='album'), popularity=43, external_ids={'isrc': 'USAT21405457'})
        mock_requests.assert_called_once()

    def test_album(self, mock_requests, mock_oauth, album_fixture: dict) -> None:
        mock_requests.return_value = MockResponse(200, album_fixture)
        result = spotify_builder('id-lol', 'secret').get_album('6jPjpEJBxT0HN71TAEohZ0')
        assert result == Album(id='6jPjpEJBxT0HN71TAEohZ0', name='Into The Wild Life (Deluxe)', external_urls={'spotify': 'https://open.spotify.com/album/6jPjpEJBxT0HN71TAEohZ0'}, href='https://api.spotify.com/v1/albums/6jPjpEJBxT0HN71TAEohZ0', uri='spotify:album:6jPjpEJBxT0HN71TAEohZ0', type='album', available_markets=['ES','GB', ], images=[Image(url='https://i.scdn.co/image/168d56d2615587c0f64a7357b94bd7e985fc52b4', height=640, width=640), Image(url='https://i.scdn.co/image/151e20dee06ace62b90bb970291cc59487552637', height=64, width=64)], total_tracks=15, release_date='2015-04-10', release_date_precision='day', artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], album_type='album', popularity=62, tracks=[Track(id='0onl8BhnRB81FjPaCU8vVI', name='Scream', external_urls={'spotify': 'https://open.spotify.com/track/0onl8BhnRB81FjPaCU8vVI'}, href='https://api.spotify.com/v1/tracks/0onl8BhnRB81FjPaCU8vVI', uri='spotify:track:0onl8BhnRB81FjPaCU8vVI', type='track', duration_ms=241853, preview_url='https://p.scdn.co/mp3-preview/d2d1819495d9301b3476ac8a277df8317a49364c?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=1, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='5MapUlM1un2Kh4aZ3IyWcL', name='I Am the Fire', external_urls={'spotify': 'https://open.spotify.com/track/5MapUlM1un2Kh4aZ3IyWcL'}, href='https://api.spotify.com/v1/tracks/5MapUlM1un2Kh4aZ3IyWcL', uri='spotify:track:5MapUlM1un2Kh4aZ3IyWcL', type='track', duration_ms=217173, preview_url='https://p.scdn.co/mp3-preview/1988f57a4abafd395b8a36139347859984130fcc?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=2, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='5dPRMnwZ7CeQF4oolO8lYo', name='Sick Individual', external_urls={'spotify': 'https://open.spotify.com/track/5dPRMnwZ7CeQF4oolO8lYo'}, href='https://api.spotify.com/v1/tracks/5dPRMnwZ7CeQF4oolO8lYo', uri='spotify:track:5dPRMnwZ7CeQF4oolO8lYo', type='track', duration_ms=207666, preview_url='https://p.scdn.co/mp3-preview/bd4661b82bf4026f7b1a930d3efcf82824c94b08?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=True, track_number=3, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='6WXN5Pvim9BKB6Wb765II5', name='Amen', external_urls={'spotify': 'https://open.spotify.com/track/6WXN5Pvim9BKB6Wb765II5'}, href='https://api.spotify.com/v1/tracks/6WXN5Pvim9BKB6Wb765II5', uri='spotify:track:6WXN5Pvim9BKB6Wb765II5', type='track', duration_ms=178226, preview_url='https://p.scdn.co/mp3-preview/076af3740d6dc9ac22b57290178d97ab4f030f05?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=4, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='0sDUFggGoxjSsYC6ffgMGL', name='Dear Daughter', external_urls={'spotify': 'https://open.spotify.com/track/0sDUFggGoxjSsYC6ffgMGL'}, href='https://api.spotify.com/v1/tracks/0sDUFggGoxjSsYC6ffgMGL', uri='spotify:track:0sDUFggGoxjSsYC6ffgMGL', type='track', duration_ms=286080, preview_url='https://p.scdn.co/mp3-preview/1fdfb094529028a34e414106d6e52e0dce4de9a9?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=5, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='4VE6xQLJtaCEWBNfR6vLU4', name='New Modern Love', external_urls={'spotify': 'https://open.spotify.com/track/4VE6xQLJtaCEWBNfR6vLU4'}, href='https://api.spotify.com/v1/tracks/4VE6xQLJtaCEWBNfR6vLU4', uri='spotify:track:4VE6xQLJtaCEWBNfR6vLU4', type='track', duration_ms=218013, preview_url='https://p.scdn.co/mp3-preview/bd3a1ce0612be880113abf66c19f2f3c2da4b412?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=6, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='6ubqrTIJwspBSqx8XQHN2K', name='Mayhem', external_urls={'spotify': 'https://open.spotify.com/track/6ubqrTIJwspBSqx8XQHN2K'}, href='https://api.spotify.com/v1/tracks/6ubqrTIJwspBSqx8XQHN2K', uri='spotify:track:6ubqrTIJwspBSqx8XQHN2K', type='track', duration_ms=216760, preview_url='https://p.scdn.co/mp3-preview/f25829ad4d06899265f8536b0856e61de77894a2?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=7, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='1Dmb79tt9hggoQdR88wIQj', name="Bad Girl's World", external_urls={'spotify': 'https://open.spotify.com/track/1Dmb79tt9hggoQdR88wIQj'}, href='https://api.spotify.com/v1/tracks/1Dmb79tt9hggoQdR88wIQj', uri='spotify:track:1Dmb79tt9hggoQdR88wIQj', type='track', duration_ms=308053, preview_url='https://p.scdn.co/mp3-preview/c3046add41f88b3ff908086445837b09baf90772?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=8, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='306aiQCuuIoB2GMu6BRx1v', name='Gonna Get Mine', external_urls={'spotify': 'https://open.spotify.com/track/306aiQCuuIoB2GMu6BRx1v'}, href='https://api.spotify.com/v1/tracks/306aiQCuuIoB2GMu6BRx1v', uri='spotify:track:306aiQCuuIoB2GMu6BRx1v', type='track', duration_ms=177480, preview_url='https://p.scdn.co/mp3-preview/ffd59e284d31553bb9ca721c51dcc8eef923e84f?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=True, track_number=9, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='5lT7sRNpl1DtGxAuvYYxIS', name='The Reckoning', external_urls={'spotify': 'https://open.spotify.com/track/5lT7sRNpl1DtGxAuvYYxIS'}, href='https://api.spotify.com/v1/tracks/5lT7sRNpl1DtGxAuvYYxIS', uri='spotify:track:5lT7sRNpl1DtGxAuvYYxIS', type='track', duration_ms=224360, preview_url='https://p.scdn.co/mp3-preview/cb09d65994c6ca631f79394808c781672cdd00ad?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=10, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='4DveRhd1VBtZyPodE3sbLj', name='Apocalyptic', external_urls={'spotify': 'https://open.spotify.com/track/4DveRhd1VBtZyPodE3sbLj'}, href='https://api.spotify.com/v1/tracks/4DveRhd1VBtZyPodE3sbLj', uri='spotify:track:4DveRhd1VBtZyPodE3sbLj', type='track', duration_ms=193613, preview_url='https://p.scdn.co/mp3-preview/f4cb055ccb15ffb9a91abb327d20556319e016d8?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=11, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='3ONPIg5DWB6V0QFUwKq8jQ', name="What Sober Couldn't Say", external_urls={'spotify': 'https://open.spotify.com/track/3ONPIg5DWB6V0QFUwKq8jQ'}, href='https://api.spotify.com/v1/tracks/3ONPIg5DWB6V0QFUwKq8jQ', uri='spotify:track:3ONPIg5DWB6V0QFUwKq8jQ', type='track', duration_ms=212973, preview_url='https://p.scdn.co/mp3-preview/5a74391c8fbe108216795f23114b2fc9cf2b886e?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=12, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='6cIZP8nszUUtkwbxEW6wBN', name='I Like It Heavy', external_urls={'spotify': 'https://open.spotify.com/track/6cIZP8nszUUtkwbxEW6wBN'}, href='https://api.spotify.com/v1/tracks/6cIZP8nszUUtkwbxEW6wBN', uri='spotify:track:6cIZP8nszUUtkwbxEW6wBN', type='track', duration_ms=294666, preview_url='https://p.scdn.co/mp3-preview/85fdbdb1baa062be800d5cbd9ed460b95b9372a1?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=True, track_number=13, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='4fzA5sZld0rC4BOs1Y3VLE', name='Jump the Gun', external_urls={'spotify': 'https://open.spotify.com/track/4fzA5sZld0rC4BOs1Y3VLE'}, href='https://api.spotify.com/v1/tracks/4fzA5sZld0rC4BOs1Y3VLE', uri='spotify:track:4fzA5sZld0rC4BOs1Y3VLE', type='track', duration_ms=188066, preview_url='https://p.scdn.co/mp3-preview/1b4b0b39b90702a447a58b6d99b0f70a1166b3f2?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=14, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None), Track(id='6snlO0ZUbyabEzie1i0BGo', name='Unapologetic', external_urls={'spotify': 'https://open.spotify.com/track/6snlO0ZUbyabEzie1i0BGo'}, href='https://api.spotify.com/v1/tracks/6snlO0ZUbyabEzie1i0BGo', uri='spotify:track:6snlO0ZUbyabEzie1i0BGo', type='track', duration_ms=247720, preview_url='https://p.scdn.co/mp3-preview/927cde9ac3a8c176db80337e2463526523aa99a1?cid=ba9301fa1fb64a4bad263047243beef4', available_markets=['ES','GB'], explicit=False, track_number=15, disc_number=1, artists=[Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=None, popularity=None, followers=None, genres=None)], is_local=False, album=None, popularity=None, external_ids=None)], copyrights=[{'text': '2015 Atlantic Recording Corporation for the United States and WEA International Inc. for the world outside of the United States. A Warner Music Group Company', 'type': 'C'}, {'text': '2015 Atlantic Recording Corporation for the United States and WEA International Inc. for the world outside of the United States. A Warner Music Group Company', 'type': 'P'}], genres=[], label='Atlantic Records', external_ids={'upc': '075679930873'})
        mock_requests.assert_called_once()

    def test_artist(self, mock_requests, mock_oauth, artist_fixture: dict) -> None:
        mock_requests.return_value = MockResponse(200, artist_fixture)
        result = spotify_builder('id-lol', 'secret').get_artist('6om12Ev5ppgoMy3OYSoech')
        assert result == Artist(id='6om12Ev5ppgoMy3OYSoech', name='Halestorm', external_urls={'spotify': 'https://open.spotify.com/artist/6om12Ev5ppgoMy3OYSoech'}, href='https://api.spotify.com/v1/artists/6om12Ev5ppgoMy3OYSoech', uri='spotify:artist:6om12Ev5ppgoMy3OYSoech', type='artist', images=[Image(url='https://i.scdn.co/image/1abdf5892fd2fb15458fbf510ac0caa27dc9bd8b', height=640, width=640), Image(url='https://i.scdn.co/image/df8ca87d303f86663380eecb18ad33fb543516b9', height=160, width=160)], popularity=68, followers={'href': None, 'total': 809990}, genres=['alternative metal', 'nu metal', 'post-grunge'])
        mock_requests.assert_called_once()
